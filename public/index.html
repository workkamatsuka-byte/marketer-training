<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rakuten Marketer Training - Firebase Sync Feedback</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* 元のファイルに近い基本的なスタイルを維持 */
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
        }
        .rakuten-red {
            color: #BF0000;
        }
        .bg-rakuten-red {
            background-color: #BF0000;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            height: 300px;
            margin: 0 auto;
        }
        /* スクロールバーのカスタムスタイル */
        .custom-scroll::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #BF0000;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #A00000;
        }
        
        /* ローディングアニメーション */
        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(191, 0, 0, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(191, 0, 0, 0);
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-200 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="text-center">
            <i class="fa-solid fa-sync fa-spin rakuten-red text-3xl"></i>
            <p class="mt-4 text-slate-700">システムを初期化しています...</p>
        </div>
    </div>

    <!-- Header (元のUIを再現) -->
    <header class="bg-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-slate-900 flex items-center">
                <i class="fa-solid fa-medal rakuten-red mr-3"></i>
                Rakuten Marketer Training System
            </h1>
            <div class="flex items-center space-x-3 text-right">
                <span id="auth-status" class="text-xs font-semibold text-gray-500">未接続</span>
                <div class="hidden md:block">
                    <span class="text-xs text-slate-500 block">User ID:</span>
                    <span id="user-id-display" class="text-xs font-mono bg-red-50 px-2 py-0.5 rounded text-slate-700 break-all">...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        
        <!-- Status Message Area -->
        <div id="status-message" class="mb-6"></div>

        <!-- Role Selector (元のUIにはないため、情報提供として簡略表示) -->
        <div class="mb-8 p-4 bg-red-100 rounded-xl flex items-center shadow">
             <i class="fa-solid fa-user-gear rakuten-red mr-3 text-xl"></i>
             <span class="text-slate-800 font-bold">現在のロール: 研修生/指導者 (データ編集可能)</span>
        </div>

        <!-- Task Submission Form Section (元のUIを再現 + PDCA項目追加) -->
        <section class="bg-white p-6 md:p-10 rounded-2xl shadow-xl border border-red-300 mb-12">
            <h2 class="text-2xl font-extrabold text-slate-800 mb-8 flex items-center border-b pb-3 rakuten-red">
                <i class="fa-solid fa-square-pen mr-3"></i>
                タスク記録フォーム (PDCA)
            </h2>

            <form id="task-form" class="space-y-6">

                <!-- Basic Info: Task Name, Target/Actual Time -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1">
                        <label for="name" class="block text-sm font-bold text-slate-700 mb-1">タスク名 <span class="text-red-500">*</span></label>
                        <input type="text" id="name" name="name" required 
                               class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 p-3" 
                               placeholder="例: LP改善のワイヤーフレーム作成">
                    </div>
                    <div>
                        <label for="targetTime" class="block text-sm font-bold text-slate-700 mb-1">目標時間 (分) <span class="text-red-500">*</span></label>
                        <input type="number" id="targetTime" name="targetTime" required min="1"
                               class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 p-3" 
                               placeholder="例: 60">
                    </div>
                    <div>
                        <label for="actualTime" class="block text-sm font-bold text-slate-700 mb-1">実績時間 (分)</label>
                        <input type="number" id="actualTime" name="actualTime" min="0"
                               class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 p-3" 
                               placeholder="例: 75">
                    </div>
                    <div class="hidden"><input type="date" id="date" name="date" required value=""></div>
                </div>

                <!-- PDCA Input Fields (NEW) -->
                <div class="border-t border-gray-200 pt-6 mt-6">
                    <h3 class="text-lg font-bold text-slate-700 mb-4">PDCA報告</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Check (Evaluation) -->
                        <div>
                            <label for="pdca_evaluation" class="block text-sm font-bold text-slate-700 mb-1">評価 (Check/Evaluation)</label>
                            <textarea id="pdca_evaluation" name="pdca_evaluation" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 p-3" placeholder="タスクの達成度や効果を具体的に評価してください。"></textarea>
                        </div>

                        <!-- Success/Failure Factors -->
                        <div>
                            <label for="pdca_factor" class="block text-sm font-bold text-slate-700 mb-1">成功/失敗要因</label>
                            <textarea id="pdca_factor" name="pdca_factor" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 p-3" placeholder="なぜその結果になったのか、主要な原因を分析してください。"></textarea>
                        </div>

                        <!-- Action Plan -->
                        <div>
                            <label for="pdca_actionplan" class="block text-sm font-bold text-slate-700 mb-1">アクションプラン (Action Plan)</label>
                            <textarea id="pdca_actionplan" name="pdca_actionplan" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 p-3" placeholder="次のタスクやプロジェクトで取るべき具体的な改善行動を記述してください。"></textarea>
                        </div>

                        <!-- Related KPI -->
                        <div>
                            <label for="pdca_kpi" class="block text-sm font-bold text-slate-700 mb-1">関連KPI</label>
                            <input type="text" id="pdca_kpi" name="pdca_kpi" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 p-3" placeholder="例: CVR, ROAS, LTV">
                        </div>
                    </div>
                </div>


                <!-- Result & Insight (Existing but renamed/contextualized if needed, kept as P/D log) -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                     <h3 class="text-lg font-bold text-slate-700 mb-4">タスク詳細ログ</h3>
                    <div>
                        <label for="result" class="block text-sm font-bold text-slate-700 mb-1">結果 (定量的・定性的な成果)</label>
                        <textarea id="result" name="result" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 p-3" placeholder="例: ワイヤーフレーム作成完了。ユーザーフローを3パターン用意できた。"></textarea>
                    </div>

                    <div class="mt-4">
                        <label for="insight" class="block text-sm font-bold text-slate-700 mb-1">洞察・教訓 (Insight)</label>
                        <textarea id="insight" name="insight" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 p-3" placeholder="例: 事前の情報収集に時間がかかり、目標時間を超過。今後はインプットとアウトプットの時間を明確に分ける。"></textarea>
                    </div>
                </div>
                
                <!-- Rating & Skill Tag -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end border-t border-gray-200 pt-6 mt-6">
                    <div>
                        <label for="rating" class="block text-sm font-bold text-slate-700 mb-1">自己評価 (1-5)</label>
                        <select id="rating" name="rating"
                                class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 p-3">
                            <option value="" disabled selected>選択してください</option>
                            <option value="1">1: 全くダメ</option>
                            <option value="2">2: 改善が必要</option>
                            <option value="3">3: 標準的</option>
                            <option value="4">4: 良い</option>
                            <option value="5">5: 非常に良い</option>
                        </select>
                    </div>
                    <div>
                         <label for="skillTag" class="block text-sm font-bold text-slate-700 mb-1">関連スキルタグ (カンマ区切り)</label>
                        <input type="text" id="skillTag" name="skillTag"
                               class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 p-3" 
                               placeholder="例: UI/UX, LP改善, AARRR">
                    </div>
                </div>

                <!-- Supervisor Feedback Area (Initial Input) -->
                <div class="bg-red-50 p-6 rounded-xl mt-6 border border-red-400">
                    <label for="feedback" class="block text-lg font-extrabold text-red-800 mb-2 flex items-center">
                        <i class="fa-solid fa-user-tie mr-2"></i>
                        指導者フィードバック (任意)
                    </label>
                    <p class="text-sm text-red-700 mb-3">この欄は指導者がタスク承認時に使用します。</p>
                    <textarea id="feedback" name="feedback" rows="3" class="w-full border-red-300 rounded-lg bg-white shadow-inner p-3" placeholder="（指導者記入欄）行動評価、思考プロセスへの示唆、育成目標の進捗などを具体的に記入する"></textarea>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="w-full py-3 bg-rakuten-red text-white font-extrabold text-lg rounded-xl shadow-lg hover:bg-[#A00000] transition duration-300 flex items-center justify-center transform hover:scale-[1.01]">
                    <i class="fa-solid fa-cloud-arrow-up mr-3"></i>
                    タスクログを保存
                </button>
            </form>
        </section>

        <!-- History and Analysis Section (元のUIを再現) -->
        <section class="space-y-10">
            <h2 class="text-2xl font-extrabold text-slate-800 mb-6 flex items-center border-b pb-3 rakuten-red">
                <i class="fa-solid fa-timeline mr-3"></i>
                タスク履歴と成長分析
            </h2>
            
            <!-- Chart Visualization -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                <h3 class="text-xl font-bold text-slate-700 mb-4 border-b pb-2">
                    過去7日間の平均達成率トレンド (目標時間 / 実績時間)
                </h3>
                <div class="chart-container">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>

            <!-- History List & CSV Export -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                <h3 class="text-xl font-bold text-slate-700 mb-4 border-b pb-2 flex items-center justify-between">
                    全タスク記録
                    <button id="export-csv-button" class="bg-slate-100 text-slate-700 text-sm px-4 py-2 rounded-lg hover:bg-slate-200 transition duration-150 flex items-center">
                        <i class="fa-solid fa-file-csv mr-2"></i>
                        CSVエクスポート
                    </button>
                </h3>
                
                <div id="history-container" class="space-y-4">
                    <!-- Task list will be rendered here -->
                    <p class="text-center text-slate-500 py-4">履歴を読み込み中です...</p>
                </div>
            </div>

        </section>

    </main>
    
    <!-- JavaScript Logic (Firestore & App) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore Log Level for Debugging
        setLogLevel('Debug');

        // --- Global Variables ---
        // Firebase設定: YOUR_WEB_API_KEY と YOUR_WEB_APP_ID はFirebaseコンソールから取得してください。
        // プロジェクト設定 (Project settings) -> 全般 (General) -> マイアプリ (Your apps) -> ウェブアプリ (Web app) を選択し、「SDK 設定と構成」の欄で確認できます。
        const firebaseConfig = {
  apiKey: "AIzaSyBi5-PGKsVZi5RI9EqGcUbEZP1J7hWHWRs",
  authDomain: "marketer-training.firebaseapp.com",
  projectId: "marketer-training",
  storageBucket: "marketer-training.firebasestorage.app",
  messagingSenderId: "846173040460",
  appId: "1:846173040460:web:9e7116f51058b3535429e9",
  measurementId: "G-H77EX7CR5L"
};

        // アプリケーションID: Firestoreのパス `/artifacts/${appId}/users/...` で使用されます。
        // デフォルトとしてプロジェクトIDを使用します。
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'marketer-training';
        
        // initialAuthTokenは、サーバーサイドなどで生成したカスタム認証トークンを使用する場合に設定します。
        // 不要な場合は `null` のままで問題ありません。その場合、匿名認証が試行されます。
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db = null;
        let auth = null;
        let userId = null;
        let chartInstance = null;
        
        const state = {
            tasks: [],
        };

        // DOM Elements
        const form = document.getElementById('task-form');
        const dateInput = document.getElementById('date');
        const historyContainer = document.getElementById('history-container');
        const statusMessage = document.getElementById('status-message');
        const authStatus = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('user-id-display');
        const exportCsvButton = document.getElementById('export-csv-button');
        
        const formatDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };
        // フォームの非表示の日付フィールドに今日の日付を設定
        dateInput.value = formatDate(new Date());

        // --- Helper function for status message ---
        function showMessage(message, color = 'blue', duration = 3000) {
            // Tailwind CSSのダイナミッククラス生成はビルド時に処理されるため、
            // 実行時にも正しく機能するようにクラス名を明示的に定義するか、
            // より一般的なクラス名を使用します。ここではシンプルに固定の色で対応します。
            let bgColorClass = `bg-${color}-100`;
            let textColorClass = `text-${color}-600`;
            if (color === 'emerald') {
                bgColorClass = 'bg-emerald-100';
                textColorClass = 'text-emerald-600';
            } else if (color === 'rose') {
                bgColorClass = 'bg-rose-100';
                textColorClass = 'text-rose-600';
            } else if (color === 'orange') {
                 bgColorClass = 'bg-orange-100';
                 textColorClass = 'text-orange-600';
            } else { // default to blue
                bgColorClass = 'bg-blue-100';
                textColorClass = 'text-blue-600';
            }


            statusMessage.innerHTML = `<div class="text-center ${textColorClass} ${bgColorClass} p-2 rounded">${message}</div>`;
            
            if (duration > 0) {
                setTimeout(() => {
                    statusMessage.innerHTML = '';
                }, duration);
            }
        }

        // --- Firebase Initialization and Authentication ---
        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                authStatus.textContent = '初期化中...';

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken)
                        .catch(error => {
                            console.error("Custom Token Sign-In Failed (Falling back to Anonymous):", error);
                            // カスタムトークン認証に失敗した場合でも匿名認証を試みる
                            return signInAnonymously(auth);
                        });
                } else {
                    // initialAuthTokenが提供されていない場合は匿名認証を試みる
                    await signInAnonymously(auth);
                }

                // 認証状態の変化を監視し、認証が完了したらリスナーを設定する
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        authStatus.textContent = '認証完了';
                        authStatus.className = 'text-xs font-semibold text-emerald-600 bg-emerald-100 rounded-full px-2 py-0.5';
                        console.log("Authenticated with user ID:", userId);
                        setupListeners();
                        document.getElementById('loading-overlay').classList.add('hidden');
                    } else {
                        console.error("Authentication failed. Cannot proceed with Firestore.");
                        authStatus.textContent = '認証エラー';
                        authStatus.className = 'text-xs font-semibold text-rose-600 bg-rose-100 rounded-full px-2 py-0.5';
                        document.getElementById('loading-overlay').classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage('Firebase接続に失敗しました。詳細: ' + error.message, 'rose', 0); // エラーメッセージは非表示にしない
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // --- Firestore Data Listeners ---
        function setupListeners() {
            if (!db || !userId) return;

            // ユーザー固有のパスを使用 (daily_tasks コレクション)
            const tasksCollectionPath = `/artifacts/${appId}/users/${userId}/daily_tasks`;
            const tasksRef = collection(db, tasksCollectionPath);
            const q = query(tasksRef);

            // リアルタイムリスナーを設定
            onSnapshot(q, (snapshot) => {
                const data = [];
                snapshot.forEach(doc => {
                    const taskData = { 
                        docId: doc.id, 
                        ...doc.data() 
                    };
                    
                    if (taskData.date) {
                        const dayOfWeek = new Date(taskData.date).getDay();
                        taskData.day = ["日", "月", "火", "水", "木", "金", "土"][dayOfWeek];
                    }

                    data.push(taskData);
                });
                
                // タイムスタンプ（降順）でソート
                state.tasks = data.sort((a, b) => {
                    // timestampが存在しない、またはtoMillis()が使えない場合のフォールバックを追加
                    const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : 0;
                    return timeB - timeA;
                });
                
                renderHistory();
                renderChart();
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                showMessage('履歴の取得中にエラーが発生しました。', 'rose');
            });
        }
        
        // --- 指導者フィードバックの更新機能 (詳細パネルから呼び出し) ---
        window.saveFeedback = async (docId) => {
            if (!db || !userId || !docId) {
                showMessage('エラー: データベース接続またはIDが未完了です。', 'rose');
                return;
            }

            const feedbackInput = document.getElementById(`feedback-input-${docId}`);
            if (!feedbackInput) return;
            
            const newFeedback = feedbackInput.value.trim();
            const saveBtn = document.getElementById(`save-btn-${docId}`);

            // UIフィードバック: ローディング状態
            const originalButtonContent = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fa-solid fa-sync fa-spin mr-2"></i> 保存中...';
            saveBtn.disabled = true;

            try {
                const tasksCollectionPath = `/artifacts/${appId}/users/${userId}/daily_tasks`;
                // updateDocを使用して指定されたドキュメントIDのフィードバックフィールドを更新
                await updateDoc(doc(db, tasksCollectionPath, docId), {
                    feedback: newFeedback,
                });

                showMessage(`フィードバックを更新しました。ID: ${docId.substring(0, 8)}...`, 'emerald');

            } catch (error) {
                console.error("Firestore Update Error:", error);
                showMessage(`フィードバックの保存中にエラーが発生しました: ${error.message}`, 'rose');
            } finally {
                // UIフィードバックを元に戻す
                saveBtn.innerHTML = originalButtonContent;
                saveBtn.disabled = false;
            }
        };


        // --- データ描画 ---
        function renderHistory() {
            historyContainer.innerHTML = '';
            
            if (state.tasks.length === 0) {
                historyContainer.innerHTML = '<p class="text-center text-slate-500 py-8">まだタスク記録がありません。最初のタスクを保存しましょう！</p>';
                return;
            }

            state.tasks.forEach(task => {
                // 達成率計算 (目標時間 / 実績時間)
                const target = task.targetTime ? parseInt(task.targetTime, 10) : 0;
                const actual = task.actualTime ? parseInt(task.actualTime, 10) : 0;

                // 達成率は (目標 / 実績) * 100。実績が0の場合は計算不能として0%
                const attainmentRate = (target > 0 && actual > 0) ? 
                    Math.min(1000, Math.round((target / actual) * 100)) : 
                    (target > 0 && actual === 0 ? 0 : 0); 

                let rateColor = 'bg-gray-200 text-gray-700';
                if (attainmentRate >= 100) {
                    rateColor = 'bg-emerald-500 text-white';
                } else if (attainmentRate >= 80) {
                    rateColor = 'bg-yellow-500 text-slate-800';
                } else if (attainmentRate > 0) {
                    rateColor = 'bg-orange-500 text-white';
                }
                
                // 指導者フィードバックの有無をチェック
                const hasFeedback = (task.feedback && String(task.feedback).trim() !== '');
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg border border-gray-200 mb-4 overflow-hidden';
                card.innerHTML = `
                    <div class="p-4 flex justify-between items-start cursor-pointer transition duration-150 hover:bg-gray-50" onclick="toggleDetails('${task.docId}')">
                        <div class="flex-1 min-w-0">
                            <div class="text-xs text-slate-500 font-medium mb-1 flex items-center">
                                <i class="fa-solid fa-calendar-day mr-2 text-red-500"></i>
                                ${task.date} (${task.day}) 
                                <!-- フィードバック状態ラベル -->
                                <span class="ml-3 px-2 py-0.5 rounded-full text-xs font-semibold ${hasFeedback ? 'bg-red-200 text-red-800' : 'bg-blue-100 text-blue-700'}">
                                    <i class="fa-solid ${hasFeedback ? 'fa-comment-dots' : 'fa-list-check'} mr-1"></i>
                                    ${hasFeedback ? '指導者評価済' : 'フィードバック待機中'}
                                </span>
                            </div>
                            <h3 class="text-lg font-bold text-slate-800 mt-1 truncate">
                                ${task.name || '（タスク名未設定）'}
                            </h3>
                            <div class="mt-2 text-sm text-slate-600 space-x-4">
                                <span>自己評価: <span class="font-semibold text-yellow-600">${task.rating || '-'} / 5</span></span>
                                <span>達成率: <span class="font-black px-2 py-0.5 rounded ${rateColor}">${attainmentRate}%</span></span>
                                <span class="text-xs font-mono text-slate-400 ml-4">ID: ${task.docId.substring(0, 8)}...</span>
                            </div>
                        </div>
                        <div class="ml-4 flex-shrink-0 text-right">
                            <i id="icon-${task.docId}" class="fa-solid fa-chevron-down text-red-500 mt-3 transition-transform duration-300"></i>
                        </div>
                    </div>
                    
                    <!-- タスク詳細エリア -->
                    <div id="details-${task.docId}" class="px-4 pb-4 pt-0 space-y-3 hidden bg-gray-50 border-t border-gray-200">
                        
                        <h4 class="text-sm font-bold text-slate-700 pt-3 border-b pb-1">タスク詳細</h4>
                        ${renderDetailItem('目標時間 / 実績時間', `${target}分 / ${actual > 0 ? actual + '分' : '未記入'}`, 'fa-stopwatch', 'slate')}
                        ${renderDetailItem('結果 (定量的・定性的成果)', task.result, 'fa-trophy', 'slate')}
                        ${renderDetailItem('洞察・教訓 (Insight)', task.insight, 'fa-lightbulb', 'blue')}
                        ${renderDetailItem('関連スキルタグ', task.skillTag, 'fa-tags', 'yellow')}

                        <!-- PDCA 詳細 -->
                        <h4 class="text-sm font-bold text-slate-700 pt-3 border-b pb-1 mt-2">PDCA報告</h4>
                        ${renderDetailItem('評価 (Check)', task.pdca_evaluation, 'fa-check-circle', 'emerald')}
                        ${renderDetailItem('成功/失敗要因', task.pdca_factor, 'fa-search', 'blue')}
                        ${renderDetailItem('アクションプラン (Action)', task.pdca_actionplan, 'fa-arrow-right', 'red')}
                        ${renderDetailItem('関連KPI', task.pdca_kpi, 'fa-chart-bar', 'purple')}

                        <!-- 指導者フィードバック (直接編集可能UI) -->
                        <div class="bg-red-100 p-3 rounded-xl border border-red-300 mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <p class="text-xs font-bold text-red-800 flex items-center">
                                    <i class="fa-solid fa-user-tie text-red-600 mr-2"></i>指導者フィードバック (編集可能)
                                </p>
                            </div>
                            <textarea id="feedback-input-${task.docId}" rows="6" 
                                class="w-full border-red-400 rounded-lg bg-white shadow-inner p-3 text-sm text-red-800 focus:ring-red-500 focus:border-red-500 whitespace-pre-wrap">
                                ${task.feedback || '（指導者からのフィードバックはまだありません。編集して保存してください）'}
                            </textarea>
                            <div class="mt-3 flex justify-end">
                                <button id="save-btn-${task.docId}" onclick="saveFeedback('${task.docId}')" 
                                        class="text-sm py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150 flex items-center font-semibold">
                                    <i class="fa-solid fa-floppy-disk mr-2"></i> フィードバックを保存
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                historyContainer.appendChild(card);
            });
            
            // textareaの空白行を削除して表示を整形（必須。そうしないとtextareaの最初の行が空白になる）
            document.querySelectorAll('textarea[id^="feedback-input-"]').forEach(textarea => {
                textarea.value = textarea.value.trim();
            });
        }

        function renderDetailItem(title, content, icon, color) {
            const contentText = (content && String(content).trim() !== '') ? content : '（未記入）';
            const finalContentClass = contentText === '（未記入）' ? 'text-slate-400' : 'text-slate-800';
            
            // Tailwind CSSのダイナミッククラス生成を考慮し、iconの色クラスを固定値で直接渡す
            let iconColorClass = '';
            if (color === 'slate') iconColorClass = 'text-slate-500';
            else if (color === 'blue') iconColorClass = 'text-blue-500';
            else if (color === 'yellow') iconColorClass = 'text-yellow-500';
            else if (color === 'emerald') iconColorClass = 'text-emerald-500';
            else if (color === 'red') iconColorClass = 'text-red-500';
            else if (color === 'purple') iconColorClass = 'text-purple-500';
            else iconColorClass = 'text-gray-500'; // デフォルト

            return `
                <div>
                    <p class="text-xs font-bold text-slate-700 mb-1 flex items-center">
                        <i class="fa-solid ${icon} ${iconColorClass} mr-2"></i>
                        ${title}
                    </p>
                    <div class="text-sm ${finalContentClass} bg-white p-3 rounded-lg border border-gray-200 whitespace-pre-wrap shadow-inner custom-scroll">${contentText}</div>
                </div>
            `;
        }
        
        // --- チャート描画 ---
        function renderChart() {
            // 過去7日間のデータを集計
            const uniqueDates = Array.from(new Set(state.tasks.map(t => t.date)))
                .filter(date => date)
                .sort((a, b) => b.localeCompare(a));
            
            const chartDates = uniqueDates.slice(0, 7).reverse();

            const chartData = chartDates.map(date => {
                const tasksOnDate = state.tasks.filter(t => t.date === date);
                let totalTarget = 0;
                let totalActual = 0;
                
                tasksOnDate.forEach(t => {
                    const target = t.targetTime ? parseInt(t.targetTime, 10) : 0;
                    const actual = t.actualTime ? parseInt(t.actualTime, 10) : 0;
                    
                    if (target > 0 && actual > 0) { // 目標時間と実績時間が有効なタスクのみを計算
                        totalTarget += target;
                        totalActual += actual;
                    }
                });
                
                // 平均時間達成率を計算 (合計目標 / 合実績 * 100)
                const averageRate = totalActual > 0 ? 
                    Math.min(1000, Math.round((totalTarget / totalActual) * 100)) : 
                    0;

                return { date: date, score: averageRate };
            });
            
            const labels = chartData.map(item => item.date.substring(5).replace('-', '/'));
            const scores = chartData.map(item => item.score);

            const ctx = document.getElementById('timeChart').getContext('2d');
            
            // 既存のチャートがあれば破棄
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '平均時間達成率 (%)',
                        data: scores,
                        borderColor: '#BF0000', // Rakuten Red
                        backgroundColor: 'rgba(191, 0, 0, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#BF0000',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 200, // 200%まで表示（必要に応じて調整）
                            title: {
                                display: true,
                                text: '達成率 (%)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- 相互作用ハンドラ ---
        window.toggleDetails = (id) => {
            const details = document.getElementById(`details-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            if (details.classList.contains('hidden')) {
                // 展開時
                details.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                // 格納時
                details.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        };

        // フォーム送信ハンドラ
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db || !userId) {
                showMessage('エラー: データベース接続が未完了です。', 'rose');
                return;
            }

            const formData = new FormData(form);
            const targetTimeStr = formData.get('targetTime');
            const actualTimeStr = formData.get('actualTime');
            
            const today = formatDate(new Date());

            // データの型変換とクリーンアップ
            const data = {
                date: today,
                name: formData.get('name').trim(),
                targetTime: targetTimeStr ? parseInt(targetTimeStr, 10) : 0,
                actualTime: actualTimeStr ? parseInt(actualTimeStr, 10) : 0,
                status: 'フィードバック待機中', 
                result: formData.get('result').trim(),
                insight: formData.get('insight').trim(), 
                rating: formData.get('rating') || null,
                skillTag: formData.get('skillTag').trim(),
                feedback: formData.get('feedback').trim(),
                
                // PDCA項目を追加 (フォームから取得)
                pdca_evaluation: formData.get('pdca_evaluation').trim(),
                pdca_factor: formData.get('pdca_factor').trim(),
                pdca_actionplan: formData.get('pdca_actionplan').trim(),
                pdca_kpi: formData.get('pdca_kpi').trim(),

                timestamp: serverTimestamp(),
                userId: userId
            };

            // 必須フィールドの検証
            if (!data.name || data.targetTime <= 0) {
                showMessage('エラー: タスク名、目標時間は必須項目です。', 'rose');
                return;
            }

            try {
                const tasksCollectionPath = `/artifacts/${appId}/users/${userId}/daily_tasks`;
                await addDoc(collection(db, tasksCollectionPath), data);
                
                showMessage(`タスクログ (${data.name}) が正常に保存されました！`, 'emerald');
                
                // フォームをリセット
                form.reset();
                dateInput.value = today; // 日付は今日に戻す

            } catch (error) {
                console.error("Firestore Save Error:", error);
                showMessage(`保存中にエラーが発生しました: ${error.message}`, 'rose');
            }
        });

        // CSVエクスポートハンドラ
        exportCsvButton.addEventListener('click', () => {
            exportToCSV(state.tasks);
        });

        function exportToCSV(tasks) {
            if (tasks.length === 0) {
                showMessage('エクスポートするタスクデータがありません。', 'orange');
                return;
            }

            const separator = ',';
            const csvRows = [];

            // ヘッダー行の作成 (PDCA項目追加)
            const headers = [
                'docId', '日付', '曜日', 'タスク名', '目標時間(分)', '実績時間(分)', 
                'ステータス', 
                '結果', '洞察・教訓', 
                '評価(Check)', '成功/失敗要因', 'アクションプラン(Action)', '関連KPI',
                '自己評価(1-5)', 'スキルタグ', '指導者フィードバック'
            ];
            csvRows.push(headers.join(separator));

            // データ行の作成
            tasks.forEach(task => {
                // CSV出力のためにクォートとエスケープを処理
                const escape = (text) => `"${String(text || '').replace(/"/g, '""')}"`;

                const values = [
                    task.docId || '',
                    task.date || '',
                    task.day || '',
                    escape(task.name),
                    task.targetTime || 0,
                    task.actualTime !== 0 ? task.actualTime : '', // 実績時間0は空欄
                    task.status || '',
                    escape(task.result),
                    escape(task.insight),
                    escape(task.pdca_evaluation),
                    escape(task.pdca_factor),
                    escape(task.pdca_actionplan),
                    escape(task.pdca_kpi),
                    task.rating || '',
                    task.skillTag || '',
                    escape(task.feedback)
                ];
                csvRows.push(values.join(separator));
            });

            // CSV Blobの作成 (UTF-8 BOM付き)
            const csvString = csvRows.join('\n');
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvString], { type: 'text/csv;charset=utf-8;' }); 

            // ダウンロードリンクを作成
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'rakuten_marketer_feedback_firestore_' + new Date().toISOString().slice(0, 10) + '.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('CSVエクスポートが完了しました！', 'emerald');
        }

        // アプリケーションの開始
        window.onload = initializeAppAndAuth;
    </script>

</body>
</html>
